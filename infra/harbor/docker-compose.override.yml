# Docker Compose Overrides for Harbor
#
# This file is automatically merged with Harbor's generated docker-compose.yml.
# Place it alongside docker-compose.yml in the Harbor installation directory.
#
# Purpose: resource limits, extra volumes, and custom networking for AI-Box deployment.

services:
  # --- Core API service ---
  core:
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # --- Registry (image storage) ---
  registry:
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # --- PostgreSQL database ---
  postgresql:
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G
    volumes:
      - /data/harbor/database:/var/lib/postgresql/data
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # --- Redis cache ---
  redis:
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"

  # --- Job service (scanning, replication, GC) ---
  jobservice:
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # --- Trivy adapter ---
  trivy-adapter:
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G
    volumes:
      # Persistent Trivy DB cache to avoid re-downloading on restart.
      - /data/harbor/trivy-cache:/home/scanner/.cache/trivy
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

  # --- Portal (web UI) ---
  portal:
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"

  # --- Nginx proxy ---
  proxy:
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"
