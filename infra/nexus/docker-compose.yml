# Nexus Repository Manager 3.x Deployment
# Provides caching proxy for npm, Maven, PyPI, NuGet, Go, and Cargo registries.
# Usage: docker compose up -d
# UI/API: http://localhost:8081  HTTPS: https://localhost:8443
# Default admin password: cat /nexus-data/admin.password (first startup only)

services:
  nexus:
    image: sonatype/nexus3:3.75.1
    container_name: nexus
    restart: unless-stopped
    ports:
      - "8081:8081"   # HTTP UI and API
      - "8443:8443"   # HTTPS (requires TLS config in Nexus)
    volumes:
      - nexus-data:/nexus-data
    environment:
      # JVM tuning -- allocate ~70% of container RAM to heap
      INSTALL4J_ADD_VM_PARAMS: >-
        -Xms4g
        -Xmx12g
        -XX:MaxDirectMemorySize=2g
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -Djava.util.prefs.userRoot=/nexus-data/javaprefs
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 16g
        reservations:
          cpus: "2"
          memory: 8g
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/service/rest/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"

volumes:
  nexus-data:
    driver: local
