# =============================================================================
# AI-Box Base Image
# =============================================================================
# Ubuntu 24.04 LTS base image for all AI-Box developer sandboxes.
# Provides a secure, non-root SSH-accessible environment with common dev tools.
# Language-specific variants (java, node, full) extend this image.
# =============================================================================

FROM docker.io/library/ubuntu:24.04

LABEL maintainer="platform-team@aibox.internal" \
      version="24.04" \
      description="AI-Box base developer sandbox image" \
      org.opencontainers.image.source="https://git.internal/aibox/aibox-images" \
      org.opencontainers.image.base.name="docker.io/library/ubuntu:24.04"

# ---------------------------------------------------------------------------
# OS packages
# ---------------------------------------------------------------------------
# Combined into a single RUN to minimize layers and clean up apt cache.
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       ca-certificates \
       git \
       openssh-server \
       jq \
       vim \
       nano \
       bash \
       zsh \
       tmux \
       build-essential \
       python3 \
       python3-pip \
       curl \
       wget \
    && rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------------------------
# Install yq (YAML processor)
# ---------------------------------------------------------------------------
ARG YQ_VERSION=v4.44.6
ARG TARGETARCH=amd64
RUN curl -sSL "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_${TARGETARCH}" \
        -o /usr/local/bin/yq \
    && chmod +x /usr/local/bin/yq

# ---------------------------------------------------------------------------
# PowerShell Core 7.x (from Microsoft APT repository)
# ---------------------------------------------------------------------------
RUN . /etc/os-release \
    && curl -fsSL "https://packages.microsoft.com/config/ubuntu/${VERSION_ID}/packages-microsoft-prod.deb" \
       -o /tmp/packages-microsoft-prod.deb \
    && dpkg -i /tmp/packages-microsoft-prod.deb \
    && rm /tmp/packages-microsoft-prod.deb \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
       powershell \
    && rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------------------------
# VS Code Server (pre-installed for fast Remote SSH connect)
# ---------------------------------------------------------------------------
# Download and install latest stable VS Code Server. The commit hash is
# fetched from Microsoft's CDN at build time. Pre-installing eliminates the
# 30-60 second first-connect download. Weekly image rebuilds keep it current.
ARG VSCODE_ARCH=x64
RUN COMMIT_ID=$(curl -sSL https://update.code.visualstudio.com/api/commits/stable/server-linux-${VSCODE_ARCH} | jq -r '.[0]') \
    && mkdir -p /home/.vscode-server/bin/${COMMIT_ID} \
    && curl -sSL "https://update.code.visualstudio.com/commit:${COMMIT_ID}/server-linux-${VSCODE_ARCH}/stable" \
       -o /tmp/vscode-server.tar.gz \
    && tar -xzf /tmp/vscode-server.tar.gz -C /home/.vscode-server/bin/${COMMIT_ID} --strip-components=1 \
    && rm /tmp/vscode-server.tar.gz

# Pre-install curated VS Code extensions into the server image.
# These are installed as machine-scoped extensions so they're available
# to all users immediately on first connect.
RUN /home/.vscode-server/bin/*/bin/code-server \
      --install-extension ms-python.python \
      --install-extension golang.Go \
      --install-extension redhat.java \
      --install-extension ms-dotnettools.csharp \
      --install-extension dbaeumer.vscode-eslint \
      --install-extension esbenp.prettier-vscode \
      --install-extension eamodio.gitlens \
      --install-extension ms-vscode.makefile-tools \
      --extensions-dir /home/.vscode-server/extensions \
    || true

# VS Code settings: disable telemetry globally.
RUN mkdir -p /home/.vscode-server/data/Machine \
    && printf '{\n  "telemetry.telemetryLevel": "off"\n}\n' \
       > /home/.vscode-server/data/Machine/settings.json

# ---------------------------------------------------------------------------
# Set inotify watches for hot reload with large projects
# ---------------------------------------------------------------------------
RUN echo "fs.inotify.max_user_watches=524288" >> /etc/sysctl.conf \
    && echo "fs.inotify.max_user_watches=524288" > /etc/sysctl.d/99-aibox-inotify.conf \
    || true

# ---------------------------------------------------------------------------
# Create non-root user
# ---------------------------------------------------------------------------
RUN userdel -r ubuntu 2>/dev/null || true \
    && useradd -m -s /bin/bash -u 1000 dev \
    && passwd -d dev \
    && mkdir -p /home/dev/.ssh \
    && chmod 700 /home/dev/.ssh \
    && mv /home/.vscode-server /home/dev/.vscode-server \
    && mkdir -p /home/dev/.cache/JetBrains \
    && chown -R dev:dev /home/dev

# ---------------------------------------------------------------------------
# SSH server setup
# ---------------------------------------------------------------------------
RUN mkdir -p /run/sshd
COPY sshd_config /etc/ssh/sshd_config

# ---------------------------------------------------------------------------
# Placeholder directories for AI-Box components
# ---------------------------------------------------------------------------
# /etc/aibox   - runtime configuration and policy files
# /opt/toolpacks - pre-approved tool bundles (populated in later phases)
# /workspace   - default working directory for developer sessions
RUN mkdir -p /etc/aibox /opt/toolpacks /workspace \
    && chown dev:dev /workspace
COPY policy-default.yaml /etc/aibox/policy.yaml

# ---------------------------------------------------------------------------
# Package manager proxy configurations (Nexus mirrors)
# ---------------------------------------------------------------------------
COPY configs/package-managers/ /etc/aibox/package-managers/

# npm: system-wide config
RUN cp /etc/aibox/package-managers/npmrc /etc/npmrc

# pip: system-wide config
RUN cp /etc/aibox/package-managers/pip.conf /etc/pip.conf

# Maven: per-user settings
RUN mkdir -p /home/dev/.m2 \
    && cp /etc/aibox/package-managers/settings.xml /home/dev/.m2/settings.xml \
    && chown -R dev:dev /home/dev/.m2

# NuGet: per-user config
RUN mkdir -p /home/dev/.nuget/NuGet \
    && cp /etc/aibox/package-managers/NuGet.Config /home/dev/.nuget/NuGet/NuGet.Config \
    && chown -R dev:dev /home/dev/.nuget

# Cargo: per-user config
RUN mkdir -p /home/dev/.cargo \
    && cp /etc/aibox/package-managers/cargo-config.toml /home/dev/.cargo/config.toml \
    && chown -R dev:dev /home/dev/.cargo

# Go: system-wide env via profile.d
RUN cp /etc/aibox/package-managers/go-env.sh /etc/profile.d/aibox-go-env.sh \
    && chmod +x /etc/profile.d/aibox-go-env.sh

WORKDIR /workspace
USER dev

EXPOSE 22
