# =============================================================================
# AI-Box Java Variant Image
# =============================================================================
# Extends the base image with Eclipse Temurin JDK 21, Maven 3.9.x, and
# Gradle 8.x for Java/JVM development sandboxes.
# =============================================================================

FROM harbor.internal/aibox/base:24.04

LABEL maintainer="platform-team@aibox.internal" \
      version="21-24.04" \
      description="AI-Box Java developer sandbox (JDK 21 + Maven + Gradle)" \
      org.opencontainers.image.source="https://git.internal/aibox/aibox-images"

USER root

# ---------------------------------------------------------------------------
# Eclipse Temurin JDK 21 (from Adoptium APT repository)
# ---------------------------------------------------------------------------
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       gpg \
       apt-transport-https \
    && curl -fsSL https://packages.adoptium.net/artifactory/api/gpg/key/public \
       | gpg --dearmor -o /usr/share/keyrings/adoptium.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/adoptium.gpg] https://packages.adoptium.net/artifactory/deb noble main" \
       > /etc/apt/sources.list.d/adoptium.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
       temurin-21-jdk \
    && rm -rf /var/lib/apt/lists/*

ENV JAVA_HOME=/usr/lib/jvm/temurin-21-jdk-amd64
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# ---------------------------------------------------------------------------
# Maven 3.9.x
# ---------------------------------------------------------------------------
ARG MAVEN_VERSION=3.9.9
RUN curl -fsSL "https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz" \
        | tar -xz -C /opt \
    && ln -s "/opt/apache-maven-${MAVEN_VERSION}" /opt/maven

ENV MAVEN_HOME=/opt/maven
ENV PATH="${MAVEN_HOME}/bin:${PATH}"

# ---------------------------------------------------------------------------
# Gradle 8.x
# ---------------------------------------------------------------------------
ARG GRADLE_VERSION=8.12
RUN curl -fsSL "https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip" \
        -o /tmp/gradle.zip \
    && unzip -q /tmp/gradle.zip -d /opt \
    && ln -s "/opt/gradle-${GRADLE_VERSION}" /opt/gradle \
    && rm /tmp/gradle.zip

ENV GRADLE_HOME=/opt/gradle
ENV PATH="${GRADLE_HOME}/bin:${PATH}"

# ---------------------------------------------------------------------------
# Cache directories for dependency persistence across sessions
# ---------------------------------------------------------------------------
RUN mkdir -p /home/dev/.m2 /home/dev/.gradle \
    && chown -R dev:dev /home/dev/.m2 /home/dev/.gradle

USER dev
WORKDIR /workspace
