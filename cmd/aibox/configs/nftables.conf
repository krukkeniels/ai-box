#!/usr/sbin/nft -f
# ============================================================================
# AI-Box nftables ruleset — container egress firewall
# ============================================================================
# Forces all container traffic through the sanctioned proxy and DNS resolver.
# Everything else is dropped by default.
#
# Supports both rootful (podman bridge) and rootless (pasta) networking.
#
# Apply:  nft -f /etc/aibox/nftables.conf
# Remove: nft delete table inet aibox
# Verify: nft list table inet aibox
# ============================================================================

# Flush for idempotent re-application.
table inet aibox {
}
flush table inet aibox

table inet aibox {

    chain forward {
        type filter hook forward priority 0; policy drop;

        # ----------------------------------------------------------------
        # Stateful: allow return traffic for established connections.
        # ----------------------------------------------------------------
        ct state established,related accept

        # ----------------------------------------------------------------
        # Allow: container -> Squid proxy (HTTP/HTTPS egress via proxy).
        # ----------------------------------------------------------------
        iifname { "podman*", "pasta*" } ip daddr 127.0.0.1 tcp dport 3128 accept

        # ----------------------------------------------------------------
        # Allow: container -> CoreDNS (sanctioned DNS resolver only).
        # ----------------------------------------------------------------
        iifname { "podman*", "pasta*" } ip daddr 127.0.0.1 udp dport 53 accept

        # ----------------------------------------------------------------
        # Block: DNS to any other destination (prevent DNS bypass).
        # ----------------------------------------------------------------
        iifname { "podman*", "pasta*" } udp dport 53 drop
        iifname { "podman*", "pasta*" } tcp dport 53 drop

        # ----------------------------------------------------------------
        # Block: DNS-over-TLS (TCP 853).
        # ----------------------------------------------------------------
        iifname { "podman*", "pasta*" } tcp dport 853 drop

        # ----------------------------------------------------------------
        # Block: known DoH resolver IPs on TCP 443 (defense-in-depth).
        # Prevents DNS-over-HTTPS bypass via well-known resolvers.
        # ----------------------------------------------------------------
        # Google
        iifname { "podman*", "pasta*" } ip daddr 8.8.8.8 tcp dport 443 drop
        iifname { "podman*", "pasta*" } ip daddr 8.8.4.4 tcp dport 443 drop
        # Cloudflare
        iifname { "podman*", "pasta*" } ip daddr 1.1.1.1 tcp dport 443 drop
        iifname { "podman*", "pasta*" } ip daddr 1.0.0.1 tcp dport 443 drop
        # Quad9
        iifname { "podman*", "pasta*" } ip daddr 9.9.9.9 tcp dport 443 drop
        iifname { "podman*", "pasta*" } ip daddr 149.112.112.112 tcp dport 443 drop
        # OpenDNS
        iifname { "podman*", "pasta*" } ip daddr 208.67.222.222 tcp dport 443 drop
        iifname { "podman*", "pasta*" } ip daddr 208.67.220.220 tcp dport 443 drop
        # CleanBrowsing
        iifname { "podman*", "pasta*" } ip daddr 185.228.168.168 tcp dport 443 drop
        iifname { "podman*", "pasta*" } ip daddr 185.228.169.168 tcp dport 443 drop

        # ----------------------------------------------------------------
        # Block: QUIC / HTTP/3 (UDP 443) — prevents protocol downgrade.
        # ----------------------------------------------------------------
        iifname { "podman*", "pasta*" } udp dport 443 drop

        # ----------------------------------------------------------------
        # Block: ICMP from container interfaces.
        # ----------------------------------------------------------------
        iifname { "podman*", "pasta*" } ip protocol icmp drop
        iifname { "podman*", "pasta*" } ip6 nexthdr icmpv6 drop

        # ----------------------------------------------------------------
        # Log dropped packets (rate-limited to avoid log flooding).
        # ----------------------------------------------------------------
        iifname { "podman*", "pasta*" } limit rate 5/minute log prefix "aibox-drop: " level warn

        # ----------------------------------------------------------------
        # Default: drop everything else from container interfaces.
        # (The chain policy is drop, but this explicit rule aids readability.)
        # ----------------------------------------------------------------
        iifname { "podman*", "pasta*" } counter drop
    }
}
