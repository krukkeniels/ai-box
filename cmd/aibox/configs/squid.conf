# =============================================================================
# AI-Box Squid Proxy Configuration
# Generated by aibox — DO NOT EDIT MANUALLY
#
# This proxy enforces a default-deny egress policy. Only traffic to explicitly
# allowed internal domains is permitted. All other outbound connections are
# blocked, including HTTPS via SNI inspection.
# =============================================================================

# ---- Listener ----------------------------------------------------------------
# Bind to localhost only. Containers reach the proxy through the host network
# namespace via the container gateway address. Binding to 127.0.0.1 prevents
# any external host from using this proxy.
http_port 127.0.0.1:3128

# ---- Identity ----------------------------------------------------------------
visible_hostname aibox-proxy

# ---- ACLs: allowed domains ----------------------------------------------------
# Each domain is listed with a leading dot to also match subdomains.
# For example, .harbor.internal matches harbor.internal AND
# registry.harbor.internal.
acl aibox_allowed dstdomain .harbor.internal
acl aibox_allowed dstdomain .nexus.internal
acl aibox_allowed dstdomain .foundry.internal
acl aibox_allowed dstdomain .git.internal
acl aibox_allowed dstdomain .vault.internal

# ---- ACLs: port safety --------------------------------------------------------
# Only allow traffic to standard HTTP/HTTPS ports. This blocks attempts to
# tunnel arbitrary protocols through the proxy on non-standard ports.
acl Safe_ports port 80
acl Safe_ports port 443
acl SSL_ports port 443

# ---- ACL: CONNECT method ------------------------------------------------------
acl CONNECT method CONNECT

# ---- Access rules (order matters!) --------------------------------------------
# 1. Block requests to non-standard ports immediately.
http_access deny !Safe_ports

# 2. Block CONNECT (tunneling) to non-SSL ports.
http_access deny CONNECT !SSL_ports

# 3. Allow CONNECT tunnels to permitted domains (HTTPS).
http_access allow CONNECT aibox_allowed

# 4. Allow plain HTTP to permitted domains.
http_access allow aibox_allowed

# 5. DEFAULT DENY — block everything not explicitly allowed above.
# This is the most important rule. Without it, Squid's default behaviour
# would allow traffic to pass.
http_access deny all

# ---- SNI-based HTTPS filtering ------------------------------------------------
# Use ssl_bump in peek-and-splice mode. This inspects the TLS ClientHello SNI
# to determine the target domain WITHOUT decrypting traffic (no MITM).
# - peek: read the SNI from the ClientHello
# - splice: forward the TLS connection as-is to allowed domains
# Access control is enforced by the http_access rules above; denied domains
# never reach the splice step because the CONNECT is rejected.
ssl_bump peek all
ssl_bump splice all

# ---- Caching: disabled --------------------------------------------------------
# AI-Box uses Nexus as a caching registry/mirror. The proxy's only job is
# access control, not caching, so we disable it entirely.
cache deny all
maximum_object_size 0 KB

# ---- Logging -----------------------------------------------------------------
# Structured access log with timestamp, source IP, destination, HTTP method,
# status code, and bytes transferred. This feeds into the audit pipeline.
access_log daemon:/var/log/aibox/proxy-access.log logformat=squid
logformat squid %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %un %Sh/%<a %mt

# ---- Runtime -----------------------------------------------------------------
coredump_dir /var/spool/squid
