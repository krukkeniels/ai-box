# =============================================================================
# AI-Box Falco Rules
# Generated by aibox -- DO NOT EDIT MANUALLY
#
# These rules detect runtime security threats specific to AI-Box sandboxes.
# They target threats documented in SPEC-FINAL.md Section 20.1 and are tuned
# for developer workstation environments to minimize false positives.
#
# Severity levels:
#   critical - immediate page (15-minute SLA)
#   warning  - review within 4 hours
#   info     - dashboard only
# =============================================================================

# ---------------------------------------------------------------------------
# Rule 1: Container writes outside allowed directories
# Threat: Container escape via unexpected filesystem write
# ---------------------------------------------------------------------------
- rule: aibox_write_outside_allowed_dirs
  desc: >
    Detects when a container process writes to a path outside the allowed
    directories (/workspace, /tmp, /home/dev). This may indicate a container
    escape attempt or an attempt to modify host filesystem state.
  condition: >
    container.id != host and
    evt.type in (open, openat, openat2) and
    evt.is_open_write = true and
    not (fd.name startswith /workspace/ or
         fd.name startswith /tmp/ or
         fd.name startswith /home/dev/ or
         fd.name startswith /proc/self/ or
         fd.name startswith /dev/null or
         fd.name startswith /dev/pts/)
  output: >
    Container wrote outside allowed dirs
    (user=%user.name command=%proc.cmdline file=%fd.name container=%container.name
     image=%container.image.repository sandbox=%container.label.aibox.sandbox_id)
  priority: CRITICAL
  tags: [aibox, filesystem, escape]

# ---------------------------------------------------------------------------
# Rule 2: Container opens raw socket
# Threat: Attempt to bypass proxy (network escape)
# ---------------------------------------------------------------------------
- rule: aibox_raw_socket_open
  desc: >
    Detects when a container process opens a raw socket. Raw sockets can be
    used to bypass the Squid proxy and nftables rules, enabling direct
    network access for data exfiltration.
  condition: >
    container.id != host and
    evt.type = socket and
    evt.arg.type in (raw, packet)
  output: >
    Container opened raw socket
    (user=%user.name command=%proc.cmdline type=%evt.arg.type container=%container.name
     image=%container.image.repository sandbox=%container.label.aibox.sandbox_id)
  priority: CRITICAL
  tags: [aibox, network, escape]

# ---------------------------------------------------------------------------
# Rule 3: Container reads /proc/*/environ of another process
# Threat: Credential harvesting attempt
# ---------------------------------------------------------------------------
- rule: aibox_proc_environ_read
  desc: >
    Detects when a container process reads the environment variables of
    another process via /proc/*/environ. This is a common technique for
    harvesting credentials stored in environment variables.
  condition: >
    container.id != host and
    evt.type in (open, openat, openat2) and
    evt.is_open_read = true and
    fd.name glob /proc/*/environ and
    not fd.name = /proc/self/environ and
    not fd.name = /proc/thread-self/environ
  output: >
    Container read /proc/*/environ of another process
    (user=%user.name command=%proc.cmdline file=%fd.name container=%container.name
     image=%container.image.repository sandbox=%container.label.aibox.sandbox_id)
  priority: CRITICAL
  tags: [aibox, credentials, harvesting]

# ---------------------------------------------------------------------------
# Rule 4: Container executes ptrace syscall
# Threat: Debugging/escape attempt (defense-in-depth, seccomp should block)
# ---------------------------------------------------------------------------
- rule: aibox_ptrace_attempt
  desc: >
    Detects when a container process invokes the ptrace syscall. ptrace can
    be used for container escape or to inspect/modify other processes. This
    should already be blocked by seccomp, so any successful call indicates
    a seccomp bypass.
  condition: >
    container.id != host and
    evt.type = ptrace
  output: >
    Container attempted ptrace
    (user=%user.name command=%proc.cmdline container=%container.name
     image=%container.image.repository sandbox=%container.label.aibox.sandbox_id)
  priority: CRITICAL
  tags: [aibox, escape, ptrace]

# ---------------------------------------------------------------------------
# Rule 5: Container connects to non-allowlisted IP
# Threat: Proxy bypass attempt
# ---------------------------------------------------------------------------
- rule: aibox_connect_non_allowlisted
  desc: >
    Detects when a container process makes an outbound TCP connection to an
    IP address that is not the proxy (127.0.0.1:3128) or DNS (127.0.0.1:53).
    All container network traffic should go through the proxy; direct
    connections indicate a bypass attempt.
  condition: >
    container.id != host and
    evt.type = connect and
    evt.dir = > and
    fd.type = ipv4 and
    not (fd.sip = 127.0.0.1 and fd.sport in (3128, 53)) and
    not fd.sip = 0.0.0.0 and
    not fd.type = unix
  output: >
    Container connected to non-allowlisted IP
    (user=%user.name command=%proc.cmdline dest=%fd.sip:%fd.sport container=%container.name
     image=%container.image.repository sandbox=%container.label.aibox.sandbox_id)
  priority: WARNING
  tags: [aibox, network, bypass]

# ---------------------------------------------------------------------------
# Rule 6: Container writes to /etc/shadow or /etc/passwd
# Threat: Privilege escalation attempt
# ---------------------------------------------------------------------------
- rule: aibox_write_sensitive_auth_files
  desc: >
    Detects when a container process writes to /etc/shadow or /etc/passwd.
    These files control authentication and any writes may indicate a
    privilege escalation attempt.
  condition: >
    container.id != host and
    evt.type in (open, openat, openat2) and
    evt.is_open_write = true and
    (fd.name = /etc/shadow or fd.name = /etc/passwd or
     fd.name = /etc/sudoers or fd.name = /etc/gshadow)
  output: >
    Container wrote to sensitive auth file
    (user=%user.name command=%proc.cmdline file=%fd.name container=%container.name
     image=%container.image.repository sandbox=%container.label.aibox.sandbox_id)
  priority: CRITICAL
  tags: [aibox, privilege_escalation]

# ---------------------------------------------------------------------------
# Rule 7: Unexpected binary execution
# Threat: Supply chain attack / persistence
# ---------------------------------------------------------------------------
- rule: aibox_unexpected_binary
  desc: >
    Detects execution of binaries not present in the base image or installed
    tool packs. Unexpected binaries may indicate a supply chain compromise
    or persistence mechanism.
  condition: >
    container.id != host and
    evt.type = execve and
    not proc.name in (bash, sh, zsh, dash, node, npm, npx, java, javac, mvn,
                       gradle, python, python3, pip, pip3, go, git, ssh, sshd,
                       ls, cat, grep, find, sed, awk, curl, wget, tar, gzip,
                       make, cmake, gcc, g++, rustc, cargo, dotnet, pwsh,
                       code-server, vim, nano, less, more, head, tail, sort,
                       uniq, wc, xargs, tee, cut, tr, diff, patch, cp, mv,
                       rm, mkdir, chmod, chown, ln, env, which, id, whoami,
                       ps, top, kill, sleep, date, true, false, test, expr) and
    not proc.exepath startswith /usr/ and
    not proc.exepath startswith /bin/ and
    not proc.exepath startswith /workspace/ and
    not proc.exepath startswith /home/dev/ and
    not proc.exepath startswith /tmp/
  output: >
    Unexpected binary executed in container
    (user=%user.name command=%proc.cmdline exe=%proc.exepath container=%container.name
     image=%container.image.repository sandbox=%container.label.aibox.sandbox_id)
  priority: WARNING
  tags: [aibox, supply_chain, persistence]

# ---------------------------------------------------------------------------
# Rule 8: Shell spawn via unusual parent
# Threat: Possible reverse shell
# ---------------------------------------------------------------------------
- rule: aibox_shell_unusual_parent
  desc: >
    Detects when a shell (bash, sh, zsh) is spawned by a process that is
    not typically expected to spawn shells. This may indicate a reverse
    shell or command injection exploit.
  condition: >
    container.id != host and
    evt.type = execve and
    proc.name in (bash, sh, zsh, dash) and
    not proc.pname in (bash, sh, zsh, dash, sshd, tmux, screen, script,
                        code-server, node, python, python3, java, make,
                        sudo, su, login, init, systemd, cron, at, env,
                        timeout, xargs, find, git, docker, podman, nohup)
  output: >
    Shell spawned by unusual parent process
    (user=%user.name shell=%proc.name parent=%proc.pname grandparent=%proc.aname[2]
     command=%proc.cmdline container=%container.name
     image=%container.image.repository sandbox=%container.label.aibox.sandbox_id)
  priority: WARNING
  tags: [aibox, reverse_shell, command_injection]

# ---------------------------------------------------------------------------
# Rule 9: High-entropy DNS queries (tunneling)
# Threat: DNS tunneling for data exfiltration
# ---------------------------------------------------------------------------
- rule: aibox_high_entropy_dns
  desc: >
    Detects DNS queries with long, high-entropy subdomain labels which may
    indicate DNS tunneling being used for data exfiltration. Legitimate DNS
    queries rarely have subdomain labels longer than 40 characters.
  condition: >
    container.id != host and
    evt.type = sendto and
    fd.type = ipv4 and
    fd.sport = 53 and
    fd.l4proto = udp and
    evt.rawres.len > 80
  output: >
    Possible DNS tunneling detected (large DNS query)
    (user=%user.name command=%proc.cmdline dest=%fd.sip:%fd.sport size=%evt.rawres.len
     container=%container.name image=%container.image.repository
     sandbox=%container.label.aibox.sandbox_id)
  priority: WARNING
  tags: [aibox, dns_tunneling, exfiltration]

# ---------------------------------------------------------------------------
# Rule 10: LLM payload size exceeds threshold
# Threat: Possible bulk exfiltration via LLM channel
# ---------------------------------------------------------------------------
- rule: aibox_llm_payload_oversize
  desc: >
    Detects when a process sends an unusually large payload (>1MB) to the
    LLM API gateway. Large payloads may indicate an attempt to exfiltrate
    bulk source code or data through the LLM API channel.
  condition: >
    container.id != host and
    evt.type in (write, writev, sendto) and
    fd.type = ipv4 and
    fd.sip = 127.0.0.1 and
    fd.sport = 3128 and
    evt.rawres.len > 1048576
  output: >
    LLM payload exceeds 1MB threshold
    (user=%user.name command=%proc.cmdline size=%evt.rawres.len dest=%fd.sip:%fd.sport
     container=%container.name image=%container.image.repository
     sandbox=%container.label.aibox.sandbox_id)
  priority: WARNING
  tags: [aibox, llm, exfiltration, covert_channel]
